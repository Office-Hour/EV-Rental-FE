<section
  class="car-detail w-full flex flex-col justify-between min-h-screen py-8 gap-4 overflow-y-auto"
>
  @if (isLoading()) {
    <div class="car-detail__state">Đang tải thông tin xe…</div>
  } @else if (loadError()) {
    <div class="car-detail__state car-detail__state--error">{{ loadError() }}</div>
  } @else {
    <div
      class="w-full px-4 sm:px-6 lg:px-8 flex items-end justify-between gap-6 shrink-0 max-sm:flex-col max-sm:items-start"
    >
      <div>
        <h1 class="car-detail__title">{{ vehicleName() }}</h1>
      </div>
    </div>

    <div
      class="w-full px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)] gap-4 lg:gap-6 items-start flex-1 min-h-0 overflow-hidden"
    >
      <div class="flex flex-col gap-3 min-h-0 overflow-y-auto max-h-full">
        <section class="car-detail-card rounded-2xl p-4 sm:p-6 border">
          <div class="flex flex-col gap-0 divide-y divide-outline-variant">
            @for (metric of vehicleMetrics(); track metric.label) {
              <div
                class="car-detail__metric flex items-center gap-4 px-4 py-4 first:pt-0 last:pb-0 hover:bg-surface-container-high transition-colors"
              >
                <div
                  class="shrink-0 w-10 h-10 rounded-full bg-primary-container flex items-center justify-center"
                >
                  <mat-icon aria-hidden="true" class="car-detail__metric-icon">{{
                    metric.icon
                  }}</mat-icon>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="car-detail__metric-label">{{ metric.label }}</div>
                  <div class="car-detail__metric-value">{{ metric.value }}</div>
                </div>
              </div>
            }
            @if (!vehicleMetrics().length) {
              <p class="car-detail__empty py-8 text-center">Thông tin chi tiết đang cập nhật.</p>
            }
          </div>
        </section>
      </div>

      <aside
        class="sticky top-0 max-h-full overflow-y-auto lg:max-w-md lg:ml-auto max-lg:relative max-lg:top-0 max-lg:w-full"
      >
        @if (hasAvailability()) {
          <div class="booking-card flex flex-col gap-3 p-4 sm:p-6 rounded-2xl border">
            <header class="flex flex-col gap-1">
              <h2 class="booking-card__title">Chọn lịch trình</h2>
              <p class="booking-card__caption">
                Chọn ngày, giờ nhận và giờ trả để tiếp tục đặt xe.
              </p>
            </header>

            <div>
              <form [formGroup]="form" (ngSubmit)="submitBooking()" class="flex flex-col gap-3">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Thời gian thuê</mat-label>
                  <mat-date-range-input
                    formGroupName="range"
                    [rangePicker]="bookingRangePicker"
                    [dateFilter]="isDateAvailable"
                    #rangeInput="matDateRangeInput"
                    (dateChange)="onRangeChange(rangeInput.value, bookingRangePicker, rangeInput)"
                  >
                    <input matStartDate formControlName="start" placeholder="Bắt đầu" />
                    <input matEndDate formControlName="end" placeholder="Kết thúc" />
                  </mat-date-range-input>
                  <mat-datepicker-toggle
                    matIconSuffix
                    [for]="bookingRangePicker"
                  ></mat-datepicker-toggle>
                  <mat-date-range-picker
                    #bookingRangePicker
                    [dateClass]="dateClass"
                  ></mat-date-range-picker>
                  @if (rangeError()) {
                    <mat-error>{{ rangeError() }}</mat-error>
                  }
                </mat-form-field>

                <div class="grid grid-cols-2 gap-2 max-sm:grid-cols-1">
                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Giờ nhận</mat-label>
                    <mat-select formControlName="startTime">
                      <mat-option value="">Chọn giờ</mat-option>
                      @for (hour of hourOptions; track hour) {
                        <mat-option [value]="hour">{{ hour }}</mat-option>
                      }
                    </mat-select>
                    @if (form.controls.startTime.invalid && form.controls.startTime.touched) {
                      <mat-error>Vui lòng chọn giờ nhận.</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Giờ trả</mat-label>
                    <mat-select formControlName="endTime">
                      <mat-option value="">Chọn giờ</mat-option>
                      @for (hour of hourOptions; track hour) {
                        <mat-option [value]="hour">{{ hour }}</mat-option>
                      }
                    </mat-select>
                    @if (form.controls.endTime.invalid && form.controls.endTime.touched) {
                      <mat-error>Vui lòng chọn giờ trả.</mat-error>
                    }
                  </mat-form-field>
                </div>

                @if (bookingEstimate(); as estimate) {
                  <div class="booking-card__summary rounded-xl border p-3 flex flex-col gap-1">
                    <div class="booking-card__summary-row flex justify-between items-center">
                      <span>Số ngày thuê</span>
                      <strong>{{ estimate.days }}</strong>
                    </div>
                    <div class="booking-card__summary-row flex justify-between items-center">
                      <span>Tiền ngày</span>
                      <strong>{{ estimate.dayTotal | number: '1.0-0' }} ₫</strong>
                    </div>
                    <div class="booking-card__summary-row flex justify-between items-center">
                      <span>Số giờ thuê</span>
                      <strong>{{ estimate.hours }}</strong>
                    </div>
                    <div class="booking-card__summary-row flex justify-between items-center">
                      <span>Tiền giờ</span>
                      <strong>{{ estimate.hourTotal | number: '1.0-0' }} ₫</strong>
                    </div>
                    <div
                      class="booking-card__summary-row booking-card__summary-row--total flex justify-between items-center"
                    >
                      <span>Tổng cộng</span>
                      <strong>{{ estimate.total | number: '1.0-0' }} ₫</strong>
                    </div>
                  </div>
                }

                <button
                  type="submit"
                  mat-flat-button
                  color="primary"
                  [disabled]="!canSubmit()"
                  class="py-3"
                >
                  Đặt xe
                </button>
              </form>
            </div>

            <footer class="booking-card__footer">
              Bằng việc đặt xe, bạn đồng ý với Điều khoản sử dụng và Chính sách bảo mật của chúng
              tôi.
            </footer>
          </div>
        } @else {
          <div
            class="booking-card booking-card--unavailable flex flex-col gap-3 p-4 sm:p-6 rounded-2xl border"
          >
            <header class="flex flex-col gap-1">
              <h2 class="booking-card__title">Xe tạm thời hết lịch trống</h2>
            </header>
            <div>
              <p class="booking-card__caption">
                Xe không có ngày trống tối thiểu 1 ngày trong 60 ngày tới. Vui lòng chọn xe khác.
              </p>
            </div>
          </div>
        }
      </aside>
    </div>
  }
</section>
