<section class="fulfillment" aria-labelledby="fulfillment-title">
  <header class="fulfillment__header">
    <a class="fulfillment__back" routerLink="/staff/bookings">
      <mat-icon aria-hidden="true">arrow_back</mat-icon>
      <span>Quay lại danh sách booking</span>
    </a>
    <p class="fulfillment__eyebrow">Quy trình xử lý đặt xe</p>
    <h1 #pageHeading id="fulfillment-title" tabindex="-1">Xử lý đặt xe</h1>
    <p class="fulfillment__description">
      Hoàn tất tuần tự các bước bên dưới để chuyển đổi đặt xe thành đơn thuê hoạt động.
    </p>
  </header>

  @if (initializationErrorMessage(); as errorMessage) {
    <section class="fulfillment__error" role="alert">
      <mat-icon aria-hidden="true">error</mat-icon>
      <div class="fulfillment__error-content">
        <h2>Không thể tải thông tin booking</h2>
        <p>{{ errorMessage }}</p>
        <button type="button" (click)="retry()">Thử lại</button>
      </div>
    </section>
  } @else {
    <div class="fulfillment__layout">
      <section class="summary">
        <header class="summary__header">
          <h2>Thông tin booking</h2>
          @if (summaryView(); as summary) {
            <span class="summary__badge">{{ summary.bookingId }}</span>
          }
        </header>

        @if (summaryView(); as summary) {
          <dl class="summary__grid">
            <div>
              <dt>Trạng thái booking</dt>
              <dd>{{ summary.bookingStatusLabel }}</dd>
            </div>
            <div>
              <dt>Trạng thái xác thực</dt>
              <dd>{{ summary.verificationStatusLabel }}</dd>
            </div>
            <div>
              <dt>Khởi tạo</dt>
              <dd>{{ summary.createdAtDisplay }}</dd>
            </div>
            <div>
              <dt>Thời gian thuê</dt>
              <dd>{{ summary.rentalWindowDisplay }}</dd>
            </div>
            <div>
              <dt>Khách thuê</dt>
              <dd>{{ summary.renterName }}</dd>
            </div>
            <div>
              <dt>Giấy phép lái xe</dt>
              <dd>{{ summary.renterLicense }}</dd>
            </div>
            <div>
              <dt>Địa chỉ</dt>
              <dd>{{ summary.renterAddress }}</dd>
            </div>
            <div>
              <dt>Xe</dt>
              <dd>{{ summary.vehicleLabel }}</dd>
            </div>
            <div>
              <dt>Tiền cọc</dt>
              <dd>{{ summary.depositDisplay }}</dd>
            </div>
            @if (summary.rentalId) {
              <div>
                <dt>Mã đơn thuê</dt>
                <dd>{{ summary.rentalId }}</dd>
              </div>
            }
            @if (summary.contractId) {
              <div>
                <dt>Mã hợp đồng</dt>
                <dd>{{ summary.contractId }}</dd>
              </div>
            }
            @if (summary.inspectionId) {
              <div>
                <dt>Biên bản kiểm tra</dt>
                <dd>{{ summary.inspectionId }}</dd>
              </div>
            }
            @if (summary.renterSignatureId) {
              <div>
                <dt>Chữ ký khách</dt>
                <dd>{{ summary.renterSignatureId }}</dd>
              </div>
            }
            @if (summary.staffSignatureId) {
              <div>
                <dt>Chữ ký nhân viên</dt>
                <dd>{{ summary.staffSignatureId }}</dd>
              </div>
            }
            @if (summary.vehicleReceipt?.receivedAtDisplay) {
              <div>
                <dt>Thời điểm bàn giao</dt>
                <dd>{{ summary.vehicleReceipt?.receivedAtDisplay }}</dd>
              </div>
            }
            @if (summary.vehicleReceipt?.receivedByStaffId) {
              <div>
                <dt>Nhân viên bàn giao</dt>
                <dd>{{ summary.vehicleReceipt?.receivedByStaffId }}</dd>
              </div>
            }
          </dl>
        } @else {
          <div class="summary__loading" aria-live="polite">
            <div class="summary__spinner"></div>
            <p>Đang tải thông tin booking…</p>
          </div>
        }

        <footer class="summary__footer">
          <button type="button" class="summary__refresh" (click)="refresh()" [disabled]="isBusy()">
            <mat-icon aria-hidden="true">refresh</mat-icon>
            <span>Cập nhật dữ liệu</span>
          </button>
        </footer>
      </section>

      <section class="steps" aria-labelledby="fulfillment-steps-title">
        <header class="steps__header">
          <div>
            <h2 id="fulfillment-steps-title">Checklist xử lý</h2>
            <p>Hoàn thành lần lượt từng bước để tiếp tục tiến trình.</p>
          </div>
          <span class="steps__progress">{{ completionPercentage() }}%</span>
        </header>

        <ol class="steps__list">
          @for (step of stepViewModels(); track trackByStep($index, step)) {
            <li class="steps__item" [class.steps__item--current]="step.isCurrent">
              <div class="steps__status steps__status--{{ step.status }}" aria-hidden="true"></div>
              <div class="steps__content">
                <div class="steps__titles">
                  <h3>{{ step.title }}</h3>
                  <p>{{ step.description }}</p>
                </div>
                <span class="steps__state">{{ statusLabel(step.status) }}</span>
                @if (step.completedAtDisplay && step.status === 'fulfilled') {
                  <span class="steps__timestamp">Hoàn tất: {{ step.completedAtDisplay }}</span>
                }
                @if (step.errorMessage) {
                  <p class="steps__error" role="alert">{{ step.errorMessage }}</p>
                }

                @if (step.artifactEntries.length > 0) {
                  <dl class="steps__artifacts">
                    @for (artifact of step.artifactEntries; track artifact.label) {
                      <div>
                        <dt>{{ artifact.label }}</dt>
                        <dd>{{ artifact.value }}</dd>
                      </div>
                    }
                  </dl>
                }

                @if (step.status !== 'fulfilled') {
                  @if (step.action.kind === 'button' && step.canPerform) {
                    <button
                      type="button"
                      class="steps__cta"
                      (click)="onStepButton(step.step)"
                      [disabled]="step.disabled"
                    >
                      {{ step.action.label }}
                    </button>
                  }

                  @if (step.action.kind === 'contract' && step.canPerform) {
                    <div class="steps__form">
                      <label for="contract-provider" class="steps__label"
                        >Nhà cung cấp chữ ký số</label
                      >
                      <select
                        id="contract-provider"
                        class="steps__select"
                        [value]="selectedContractProvider()"
                        (change)="onContractProviderChange($event)"
                        [disabled]="step.disabled"
                      >
                        @for (provider of contractProviders; track provider.value) {
                          <option [value]="provider.value">{{ provider.label }}</option>
                        }
                      </select>
                      <button
                        type="button"
                        class="steps__cta"
                        (click)="onCreateContract()"
                        [disabled]="step.disabled"
                      >
                        Phát hành hợp đồng
                      </button>
                    </div>
                  }

                  @if (step.action.kind === 'inspection' && step.canPerform) {
                    <app-inspection-form
                      (submitted)="onSubmitInspection($event)"
                      [disabled]="step.disabled"
                    ></app-inspection-form>
                  }

                  @if (step.action.kind === 'signature' && step.canPerform) {
                    <app-signature-step
                      [role]="step.action.role"
                      [disabled]="step.disabled"
                      (submitted)="onSubmitSignature($event)"
                    ></app-signature-step>
                  }

                  @if (step.action.kind === 'vehicle' && step.canPerform) {
                    <form
                      class="vehicle-receive"
                      [formGroup]="vehicleReceiveForm"
                      (ngSubmit)="onSubmitVehicleReceive()"
                      novalidate
                    >
                      <label for="vehicle-receive-datetime" class="vehicle-receive__label">
                        Thời điểm bàn giao
                      </label>
                      <input
                        id="vehicle-receive-datetime"
                        type="datetime-local"
                        class="vehicle-receive__input"
                        formControlName="receivedAt"
                        [attr.aria-invalid]="vehicleReceiveError('required')"
                        required
                      />
                      @if (vehicleReceiveError('required')) {
                        <p class="vehicle-receive__error" role="alert">
                          Vui lòng chọn thời điểm bàn giao.
                        </p>
                      }
                      <div class="vehicle-receive__actions">
                        <button
                          type="submit"
                          class="vehicle-receive__submit"
                          [disabled]="step.disabled || vehicleReceiveForm.invalid"
                        >
                          Xác nhận bàn giao xe
                        </button>
                      </div>
                    </form>
                  }
                }
              </div>
            </li>
          }
        </ol>

        @if (hasFailure()) {
          <div class="steps__hint" role="status">
            <mat-icon aria-hidden="true">warning</mat-icon>
            <p>Hãy xử lý lỗi ở các bước thất bại trước khi tiếp tục.</p>
          </div>
        }
      </section>

      <section class="timeline" aria-labelledby="fulfillment-timeline-title">
        <header class="timeline__header">
          <h2 id="fulfillment-timeline-title">Nhật ký thực hiện</h2>
          <p>Theo dõi lịch sử hành động phục vụ kiểm toán.</p>
        </header>

        @if (timelineView().length === 0) {
          <div class="timeline__empty" aria-live="polite">
            <mat-icon aria-hidden="true">hourglass_empty</mat-icon>
            <p>Chưa có sự kiện nào được ghi nhận.</p>
          </div>
        } @else {
          <ol class="timeline__list">
            @for (event of timelineView(); track trackByTimeline($index, event)) {
              <li class="timeline__item">
                <div class="timeline__marker" aria-hidden="true"></div>
                <div class="timeline__body">
                  <h3>{{ event.title }}</h3>
                  @if (event.description) {
                    <p class="timeline__description">{{ event.description }}</p>
                  }
                  <p class="timeline__meta">
                    <span>{{ event.actorLabel }}</span>
                    <span aria-hidden="true">•</span>
                    <span>{{ event.occurredAtDisplay }}</span>
                  </p>
                  @if (event.metadataEntries.length > 0) {
                    <dl class="timeline__metadata">
                      @for (meta of event.metadataEntries; track meta.label) {
                        <div>
                          <dt>{{ meta.label }}</dt>
                          <dd>{{ meta.value }}</dd>
                        </div>
                      }
                    </dl>
                  }
                </div>
              </li>
            }
          </ol>
        }
      </section>
    </div>
  }
</section>
